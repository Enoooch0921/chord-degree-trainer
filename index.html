<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å’Œå¼¦ç´šæ•¸ç·´ç¿’ï¼ˆå¤§èª¿ï¼‰</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151933; --ink:#e8ecff; --muted:#aab0d6; --accent:#6ea8ff;
    --ok:#2ecc71; --bad:#ff6b6b; --btn:#20264d; --btn-hover:#28306a; --chip:#1c2145; --border:#2a2f58;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 80% -10%, #1a1f45 0%, #0f1220 60%);
    color:var(--ink);
    padding-bottom:92px; /* è®“å…§å®¹ä¸è¢«åº•éƒ¨æ§åˆ¶åˆ—é®ä½ */
  }
  .wrap{max-width:1100px; margin:32px auto; padding:0 16px}
  header{display:flex; gap:16px; align-items:center; margin-bottom:16px}
  h1{font-size:22px; margin:0}
  .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:var(--chip); color:var(--muted); border:1px solid var(--border)}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.05)), var(--panel);
    border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom:14px
  }
  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid-2{grid-template-columns: 1fr 1fr} }
  label{font-size:13px; color:var(--muted)}
  select, .seg, button, .check, input[type="number"]{
    background:var(--btn); color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:15px
  }
  input[type="number"]{width:90px}
  .check{display:flex; gap:8px; align-items:center; padding:8px 12px}
  select:focus, button:focus, input[type="number"]:focus{outline:2px solid var(--accent)}
  .seg{display:inline-flex; gap:6px; padding:6px; align-items:center}
  .seg input{display:none}
  .seg label{
    color:var(--ink); background:transparent; border:1px solid var(--border);
    padding:8px 12px; border-radius:8px; cursor:pointer; user-select:none
  }
  .seg input:checked + label{background:var(--accent); border-color:transparent; color:#0c1226; font-weight:700}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .grow{flex:1}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:var(--muted);
        border:1px solid var(--border); padding:3px 6px; border-radius:6px; background:var(--chip)}
  .question{
    display:flex; align-items:center; justify-content:space-between; gap:12px; min-height:64px;
    border:1px dashed var(--border); border-radius:12px; padding:12px; background:rgba(255,255,255,0.02)
  }
  .q-title{font-size:18px; line-height:1.3}
  .q-meta{color:var(--muted); font-size:13px}
  .big{font-size:28px; font-weight:800; letter-spacing:0.5px}
  .choices{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px}
  @media (min-width:680px){ .choices{grid-template-columns: repeat(4, minmax(0,1fr));} }
  .choice{
    padding:12px; background:var(--btn); border:1px solid var(--border); border-radius:10px; cursor:pointer; text-align:center;
    transition:transform .06s ease, background .15s ease; position:relative
  }
  .choice:hover{background:var(--btn-hover); transform:translateY(-1px)}
  .choice.correct{background:rgba(46, 204, 113, .15); border-color:rgba(46, 204, 113, .4)}
  .choice.wrong{background:rgba(255,107,107,.2); border-color:rgba(255,107,107,.5)}
  .idxHint{ position:absolute; top:6px; left:8px; font-size:11px; opacity:.7}
  .result{display:flex; align-items:center; gap:10px; font-size:15px; margin-top:8px}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
  .score{display:flex; gap:10px; flex-wrap:wrap; font-size:14px; color:var(--muted)}
  .score strong{color:var(--ink)}
  .list{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
  .chip{padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); font-size:13px}
  .muted{color:var(--muted)}
  details summary{cursor:pointer; user-select:none; color:var(--muted)}
  .footer{color:var(--muted); font-size:12px; margin-top:12px}

  /* è¨ˆæ™‚å™¨é¡¯ç¤º */
  .timer{ margin-top:10px; }
  .tline{ height:10px; border-radius:999px; background:#22284d; border:1px solid var(--border); overflow:hidden }
  .tbar{ height:100%; background:var(--accent); width:0% }
  .tmeta{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px}

  /* åº•éƒ¨å›ºå®šæ§åˆ¶åˆ— */
  .dock{
    position:fixed; left:0; right:0; bottom:0; z-index:50;
    background:rgba(21,25,51,.88); backdrop-filter: blur(10px);
    border-top:1px solid var(--border);
  }
  .dock-inner{
    max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap
  }
  .btn{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--ink); cursor:pointer}
  .btn.primary{background:var(--accent); border-color:transparent; color:#0c1226; font-weight:800}
  .btn.ghost{background:transparent}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>å’Œå¼¦ç´šæ•¸ç·´ç¿’ï¼ˆå¤§èª¿ï¼‰</h1>
      <span class="badge">I ii iii IV V vi viiÂ°</span>
      <span class="badge">ç«‹å³åˆ¤æ–·</span>
      <span class="badge">éµç›¤ 1â€“7 ä¾ç•«é¢é †åº</span>
    </header>

    <div class="panel grid grid-2" id="controls">
      <div class="grid">
        <div>
          <label>ç·´ç¿’æ¨¡å¼</label><br/>
          <div class="seg" role="tablist" aria-label="ç·´ç¿’æ¨¡å¼">
            <input type="radio" name="mode" id="m1" value="chordToDegree" checked />
            <label for="m1">å’Œå¼¦ âœ ç´šæ•¸</label>
            <input type="radio" name="mode" id="m2" value="degreeToChord" />
            <label for="m2">ç´šæ•¸ âœ å’Œå¼¦</label>
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label for="root">ä¸»éŸ³ï¼ˆKey Rootï¼‰</label>
            <select id="root">
              <option>C</option><option>C#</option><option>D</option><option>Eb</option>
              <option>E</option><option>F</option><option>F#</option><option>G</option>
              <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
            </select>
          </div>

          <div class="grow">
            <label>å‡ºé¡Œæ–¹å¼</label><br/>
            <div class="seg">
              <input type="radio" name="keymode" id="kfix" value="fixed" checked />
              <label for="kfix">å›ºå®šèª¿æ€§</label>
              <input type="radio" name="keymode" id="krand" value="random" />
              <label for="krand">æ¯é¡Œéš¨æ©Ÿèª¿æ€§</label>
            </div>
          </div>
        </div>

        <div class="row">
          <label class="check" title="é¿å…ç”¨æŒ‰éˆ•ä½ç½®ä½œç­”">
            <input type="checkbox" id="shuffleChoices" checked />
            <span id="shuffleText">éš¨æ©Ÿæ’åˆ—é¸é …ï¼ˆæ­¤æ¨¡å¼ä¸æ‰“äº‚ï¼‰</span>
          </label>
        </div>

        <div class="row">
          <label class="check" title="é€¾æ™‚è‡ªå‹•ç®—éŒ¯ä¸¦æ›é¡Œ">
            <input type="checkbox" id="timedMode" />
            <span>è¨ˆæ™‚æ¨¡å¼ï¼ˆ5 ç§’ï¼‰</span>
          </label>
          <div class="row" style="gap:6px">
            <label for="timeLimit" class="muted">ç§’æ•¸</label>
            <input type="number" id="timeLimit" min="3" max="60" value="5" />
          </div>
          <button class="btn ghost" id="pauseBtn" disabled>æš«åœ</button>
        </div>

        <div class="score" id="score">
          <div>âœ… ç­”å°ï¼š<strong id="okCnt">0</strong></div>
          <div>âŒ ç­”éŒ¯ï¼š<strong id="badCnt">0</strong></div>
          <div>ğŸ”¥ é€£çºŒï¼š<strong id="streak">0</strong></div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>æ­¤èª¿çš„ 7 å€‹å’Œå¼¦ï¼ˆåƒè€ƒï¼‰</label>
          <div id="overview" class="list"></div>
          <div class="footer">ï¼Šå¤§èª¿ï¼šI ii iii IV V vi viiÂ°</div>

          <div class="timer" id="timerBox" hidden>
            <div class="tline"><div class="tbar" id="tbar"></div></div>
            <div class="tmeta">
              <span id="tlabel" class="muted">å‰©é¤˜ï¼šâ€”</span>
              <span class="muted">é€¾æ™‚è‡ªå‹•ç®—éŒ¯</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="question" id="qbox">
        <div>
          <div class="q-meta" id="qKey">èª¿æ€§ï¼š</div>
          <div class="q-title">é¡Œç›®ï¼š<span class="big" id="qText">æŒ‰ä¸‹æ–¹ã€Œé–‹å§‹ã€å‡ºé¡Œ</span></div>
        </div>
        <div>
          <span class="kbd">1â€“7</span>
        </div>
      </div>
      <div id="choices" class="choices" aria-label="é¸é …"></div>
      <div class="result" id="result" hidden>
        <span class="dot" id="rDot"></span>
        <span id="rText"></span>
      </div>
    </div>

    <div class="panel">
      <details>
        <summary>èªªæ˜ / å°æé†’</summary>
        <ul>
          <li>ç›®å‰åƒ…æä¾›ã€Œå¤§èª¿ã€ã€‚</li>
          <li>åƒ…åœ¨ã€Œç´šæ•¸ âœ å’Œå¼¦ã€æ™‚æœƒä¾å‹¾é¸ç‹€æ…‹æ‰“äº‚é¸é …ï¼›ã€Œå’Œå¼¦ âœ ç´šæ•¸ã€å›ºå®š I ii iii IV V vi viiÂ° é †åºã€‚</li>
          <li>è¨ˆæ™‚æ¨¡å¼ï¼šé€¾æ™‚è¦–åŒç­”éŒ¯ä¸¦è‡ªå‹•æ›é¡Œï¼Œå¯æš«åœ / ç¹¼çºŒã€‚</li>
          <li>éµç›¤ï¼š<span class="kbd">1â€“7</span> ä¾ç•«é¢é †åºä½œç­”ã€<span class="kbd">N</span> ä¸‹ä¸€é¡Œã€<span class="kbd">P</span> æš«åœ/ç¹¼çºŒã€<span class="kbd">L</span> åˆ‡æ›ç¸½è¦½ã€‚</li>
        </ul>
      </details>
    </div>

    <div class="footer muted">Â© å’Œå¼¦ç´šæ•¸ç·´ç¿’ï½œå–®æª”ç‰ˆï¼Œé›¢ç·šå¯ç”¨ã€‚</div>
  </div>

  <!-- åº•éƒ¨å›ºå®šæ§åˆ¶åˆ— -->
  <div class="dock">
    <div class="dock-inner">
      <button class="btn" id="toggleList">é¡¯ç¤º / éš±è—ç¸½è¦½</button>
      <button class="btn ghost" id="resetScore">é‡ç½®åˆ†æ•¸</button>
      <div class="grow"></div>
      <button class="btn" id="nextBtn">é–‹å§‹</button>
      <button class="btn primary" id="nextBtn2">ä¸‹ä¸€é¡Œ</button>
    </div>
  </div>

<script>
(function(){
  // ---------- å¤§èª¿è³‡æ–™ ----------
  const NOTE_TO_PC = {
    'C':0,'B#':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'Fb':4,'F':5,'E#':5,
    'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11,'Cb':11
  };
  const NAMES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const NAMES_FLAT  = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

  const STEPS_MAJOR = [0,2,4,5,7,9,11];
  const ROMAN_MAJOR = ["I","ii","iii","IV","V","vi","viiÂ°"];
  const QUAL_MAJOR  = ['maj','min','min','maj','maj','min','dim'];
  const MAJOR_FLAT_PREF = new Set(['F','Bb','Eb','Ab','Db']);

  // ---------- å°å·¥å…· ----------
  const rand = (n)=> Math.floor(Math.random()*n);
  const pick = (arr)=> arr[rand(arr.length)];
  function pcToName(pc, preferSharps){ return (preferSharps?NAMES_SHARP:NAMES_FLAT)[((pc%12)+12)%12]; }
  function parseRootName(s){ return NOTE_TO_PC[s] ?? 0; }
  function guessPreferSharps(rootStr){
    if (rootStr.includes('b')) return false;
    if (rootStr.includes('#')) return true;
    const name = pcToName(parseRootName(rootStr), true);
    if (MAJOR_FLAT_PREF.has(name.replace('#',''))) return false;
    return true;
  }
  function triadsMajor(rootName){
    const rootPC = parseRootName(rootName);
    const preferSharps = guessPreferSharps(rootName);
    const chords = STEPS_MAJOR.map((st,i)=>{
      const pc = (rootPC + st) % 12;
      let name = pcToName(pc, preferSharps);
      const q = QUAL_MAJOR[i];
      if (q==='min') name += 'm';
      else if (q==='dim') name += 'Â°';
      return { degree:i, roman:ROMAN_MAJOR[i], name, quality:q, pc };
    });
    return { chords };
  }
  function shuffledIndices(n){
    const a = Array.from({length:n}, (_,i)=>i);
    for(let i=n-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // ---------- DOM ----------
  const els = {
    mode: ()=> document.querySelector('input[name="mode"]:checked').value,
    keymode: ()=> document.querySelector('input[name="keymode"]:checked').value,
    root: document.getElementById('root'),
    overview: document.getElementById('overview'),
    qKey: document.getElementById('qKey'),
    qText: document.getElementById('qText'),
    choices: document.getElementById('choices'),
    result: document.getElementById('result'),
    rDot: document.getElementById('rDot'),
    rText: document.getElementById('rText'),
    okCnt: document.getElementById('okCnt'),
    badCnt: document.getElementById('badCnt'),
    streak: document.getElementById('streak'),
    toggleList: document.getElementById('toggleList'),
    resetScore: document.getElementById('resetScore'),
    qbox: document.getElementById('qbox'),
    shuffle: document.getElementById('shuffleChoices'),
    shuffleText: document.getElementById('shuffleText'),
    // è¨ˆæ™‚
    timedMode: document.getElementById('timedMode'),
    timeLimit: document.getElementById('timeLimit'),
    timerBox: document.getElementById('timerBox'),
    tbar: document.getElementById('tbar'),
    tlabel: document.getElementById('tlabel'),
    pauseBtn: document.getElementById('pauseBtn'),
    // åº•éƒ¨æ§åˆ¶
    nextBtn: document.getElementById('nextBtn'),
    nextBtn2: document.getElementById('nextBtn2'),
    // æ¨¡å¼åˆ‡æ›
    m1: document.getElementById('m1'),
    m2: document.getElementById('m2'),
  };

  // ---------- ç‹€æ…‹ ----------
  const state = {
    ok:0, bad:0, streak:0,
    lock:false,
    current:null,
    showList:true,
    // è¨ˆæ™‚ç‹€æ…‹
    timer: { timeoutId:null, intervalId:null, endAt:0, remainingMs:0, paused:false, running:false }
  };

  function updateScoreboard(){
    els.okCnt.textContent = state.ok;
    els.badCnt.textContent = state.bad;
    els.streak.textContent = state.streak;
  }

  function renderOverview(){
    const { chords } = triadsMajor(els.root.value);
    const list = chords.map(c=> `<span class="chip"><strong style="margin-right:6px">${c.roman}</strong>${c.name}</span>`).join('');
    els.overview.innerHTML = state.showList ? list : `<span class="muted">ï¼ˆå·²éš±è—ï¼‰</span>`;
  }

  function setResult(ok, message){
    els.result.hidden = false;
    els.rDot.className = 'dot ' + (ok?'ok':'bad');
    els.rText.textContent = message;
    els.qbox.style.borderColor = ok ? 'rgba(46, 204, 113, .6)' : 'rgba(255,107,107,.7)';
    setTimeout(()=>{ els.qbox.style.borderColor = 'var(--border)'; }, 300);
  }

  function clearResult(){
    els.result.hidden = true;
    els.rText.textContent = '';
  }

  // ---------- è¨ˆæ™‚æ§åˆ¶ ----------
  function stopTimer(){
    const t = state.timer;
    if (t.timeoutId){ clearTimeout(t.timeoutId); t.timeoutId=null; }
    if (t.intervalId){ clearInterval(t.intervalId); t.intervalId=null; }
    t.running = false;
  }
  function resetTimerUI(){
    els.tbar.style.width = '0%';
    els.tlabel.textContent = 'å‰©é¤˜ï¼šâ€”';
  }
  function startTimer(){
    const enabled = els.timedMode.checked;
    if (!enabled){ stopTimer(); els.timerBox.hidden = true; els.pauseBtn.disabled = true; return; }
    els.timerBox.hidden = false;
    els.pauseBtn.disabled = false;

    const t = state.timer;
    const limitMs = Math.max(3, Math.min(60, Number(els.timeLimit.value)||5)) * 1000;

    // è‹¥æ˜¯å¾æš«åœæ¢å¾©ï¼Œä½¿ç”¨ remainingMsï¼›å¦å‰‡é‡ç½®ç‚ºæ•´æ®µ
    const startMs = performance.now();
    const duration = (t.paused && t.remainingMs>0) ? t.remainingMs : limitMs;
    t.paused = false;
    t.remainingMs = duration;
    t.endAt = startMs + duration;
    t.running = true;

    // å…ˆæ¸…ç†
    stopTimer();

    // è¦–è¦ºæ¯ 100ms æ›´æ–°
    t.intervalId = setInterval(()=>{
      const now = performance.now();
      const left = Math.max(0, t.endAt - now);
      t.remainingMs = left;
      const pct = 100 * (left / duration);
      els.tbar.style.width = `${pct}%`;
      els.tlabel.textContent = `å‰©é¤˜ï¼š${(left/1000).toFixed(1)}s`;
    }, 100);

    // åˆ°æ™‚ï¼šç›´æ¥ç®—éŒ¯ä¸¦è‡ªå‹•ä¸‹ä¸€é¡Œ
    t.timeoutId = setTimeout(()=>{
      if (state.lock) return; // å·²ä½œç­”å‰‡å¿½ç•¥
      const correctBtn = [...document.querySelectorAll('.choice')]
        .find(b => Number(b.dataset.actual) === state.current?.answerIdx);
      if (correctBtn) correctBtn.classList.add('correct');
      state.bad += 1; state.streak = 0;
      setResult(false, 'é€¾æ™‚ï¼é€™é¡Œç®—éŒ¯ï¼Œç¹¼çºŒä¸‹ä¸€é¡Œã€‚');
      updateScoreboard();
      lockChoices();
      stopTimer();
      setTimeout(nextQuestion, 600);
    }, duration);
  }

  function togglePause(){
    const t = state.timer;
    if (!els.timedMode.checked) return;
    if (!t.running && !t.paused){ // å°šæœªé–‹å§‹
      startTimer();
      els.pauseBtn.textContent = 'æš«åœ';
      return;
    }
    if (t.paused){
      startTimer();
      els.pauseBtn.textContent = 'æš«åœ';
    }else{
      t.paused = true;
      stopTimer();
      els.pauseBtn.textContent = 'ç¹¼çºŒ';
    }
  }

  // ---------- å‡ºé¡Œ ----------
  function updateShuffleLabel(){
    if (els.mode()==='degreeToChord'){
      els.shuffleText.textContent = 'éš¨æ©Ÿæ’åˆ—é¸é …ï¼ˆé¿å…ä½ç½®è¨˜æ†¶ï¼‰';
    }else{
      els.shuffleText.textContent = 'éš¨æ©Ÿæ’åˆ—é¸é …ï¼ˆæ­¤æ¨¡å¼ä¸æ‰“äº‚ï¼‰';
    }
  }

  function nextQuestion(){
    state.lock = false;
    clearResult();
    els.choices.innerHTML = '';

    // æ±ºå®šèª¿æ€§
    let root = els.root.value;
    if (els.keymode() === 'random'){
      const ROOTS = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'];
      root = pick(ROOTS);
    }

    const { chords } = triadsMajor(root);
    const mode = els.mode();
    els.qKey.textContent = `èª¿æ€§ï¼š${root} å¤§èª¿`;

    // é¸ç›®æ¨™ï¼ˆæ­£è§£ï¼‰
    const target = pick(chords);
    state.current = { root, mode, answerIdx: target.degree, target };

    // åªåœ¨ã€Œç´šæ•¸ âœ å’Œå¼¦ã€æ™‚å¯æ‰“äº‚
    const shouldShuffle = (els.shuffle.checked && mode === 'degreeToChord');
    const order = shouldShuffle ? shuffledIndices(7) : Array.from({length:7},(_,i)=>i);

    if (mode === 'chordToDegree'){
      // é¡Œå¹¹é¡¯ç¤ºå’Œå¼¦ï¼›é¸é …ç‚ºå›ºå®š I ii iii IV V vi viiÂ°
      els.qText.textContent = target.name;
      order.forEach((k, visualIdx)=>{
        const lab = ROMAN_MAJOR[k];
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.dataset.actual = String(k);
        btn.innerHTML = `<span class="idxHint">${visualIdx+1}</span><div style="font-weight:800">${lab}</div><div class="muted" style="font-size:12px">ç´šæ•¸</div>`;
        btn.addEventListener('click', ()=> onChoose(k, btn));
        els.choices.appendChild(btn);
      });
    }else{
      // é¡Œå¹¹é¡¯ç¤ºç´šæ•¸ï¼›é¸é …æ˜¯å’Œå¼¦ï¼ˆæ­¤æ¨¡å¼å¯ä¾å‹¾é¸æ‰“äº‚ï¼‰
      els.qText.textContent = target.roman;
      order.forEach((k, visualIdx)=>{
        const c = chords[k];
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.dataset.actual = String(k);
        btn.innerHTML = `<span class="idxHint">${visualIdx+1}</span><div style="font-weight:800">${c.name}</div><div class="muted" style="font-size:12px">å’Œå¼¦</div>`;
        btn.addEventListener('click', ()=> onChoose(k, btn));
        els.choices.appendChild(btn);
      });
    }

    // é‡ç¹ªç¸½è¦½
    renderOverview();

    // è¨ˆæ™‚æ§åˆ¶
    resetTimerUI();
    state.timer.paused = false;
    state.timer.remainingMs = 0;
    if (els.timedMode.checked){
      startTimer();
      els.pauseBtn.textContent = 'æš«åœ';
    }else{
      stopTimer();
      els.pauseBtn.disabled = true;
    }

    // æ›´æ–°åº•éƒ¨æŒ‰éˆ•æ–‡å­—èˆ‡äº‚åºæç¤º
    els.nextBtn.textContent = 'é–‹å§‹';
    els.nextBtn2.textContent = 'ä¸‹ä¸€é¡Œ';
    updateShuffleLabel();
  }

  function lockChoices(){
    state.lock = true;
    document.querySelectorAll('.choice').forEach(b=> b.disabled = true);
  }

  // ä½œç­”ï¼ˆå«è‡ªå‹•ä¸‹ä¸€é¡Œï¼‰
  function onChoose(idx, btnEl){
    if (state.lock || !state.current) return;
    const correct = idx === state.current.answerIdx;
    const all = Array.from(document.querySelectorAll('.choice'));
    const correctBtn = all.find(b => Number(b.dataset.actual) === state.current.answerIdx);

    if (correct){
      btnEl.classList.add('correct');
      state.ok += 1; state.streak += 1;
      setResult(true, 'ç­”å°äº†ï¼');
      updateScoreboard();
      lockChoices();
      stopTimer();
      setTimeout(nextQuestion, 600);
    }else{
      btnEl.classList.add('wrong');
      if (correctBtn) correctBtn.classList.add('correct');
      state.bad += 1; state.streak = 0;
      const tip = (state.current.mode==='chordToDegree')
        ? `æ­£ç¢ºç´šæ•¸ï¼š${ROMAN_MAJOR[state.current.answerIdx]}`
        : `æ­£ç¢ºå’Œå¼¦ï¼š${triadsMajor(els.root.value).chords[state.current.answerIdx].name}`;
      setResult(false, `å†è©¦è©¦ï½ ${tip}`);
      updateScoreboard();
      lockChoices();
      stopTimer();
      setTimeout(nextQuestion, 600);
    }
  }

  // ---------- äº‹ä»¶ ----------
  // åº•éƒ¨æ§åˆ¶åˆ—
  els.nextBtn.addEventListener('click', nextQuestion);    // ã€Œé–‹å§‹ã€
  els.nextBtn2.addEventListener('click', nextQuestion);   // ã€Œä¸‹ä¸€é¡Œã€

  // å…¶ä»–æ§åˆ¶
  document.getElementById('toggleList').addEventListener('click', ()=>{ state.showList = !state.showList; renderOverview(); });
  els.resetScore.addEventListener('click', ()=>{
    state.ok = state.bad = state.streak = 0; updateScoreboard(); clearResult();
    document.querySelectorAll('.choice').forEach(b=>{ b.classList.remove('correct','wrong'); b.disabled=false; });
    stopTimer(); resetTimerUI();
  });

  // è¨ˆæ™‚æ¨¡å¼/ç§’æ•¸æ”¹è®Š
  els.timedMode.addEventListener('change', ()=>{
    if (els.timedMode.checked){
      els.pauseBtn.disabled = false;
      if (state.current && !state.lock){ startTimer(); els.pauseBtn.textContent='æš«åœ'; }
      els.timerBox.hidden = false;
    }else{
      stopTimer(); resetTimerUI(); els.timerBox.hidden = true; els.pauseBtn.disabled = true; els.pauseBtn.textContent='æš«åœ';
    }
  });
  els.timeLimit.addEventListener('change', ()=>{
    if (els.timedMode.checked && state.current && !state.lock){
      startTimer();
    }
  });
  els.pauseBtn.addEventListener('click', togglePause);

  // æ ¹éŸ³èˆ‡æ¨¡å¼è®Šæ›´
  els.root.addEventListener('change', renderOverview);
  els.m1.addEventListener('change', updateShuffleLabel);
  els.m2.addEventListener('change', updateShuffleLabel);

  // éµç›¤å¿«æ·ï¼š1â€“7 ä½œç­”ã€N ä¸‹ä¸€é¡Œã€P æš«åœ/ç¹¼çºŒã€L åˆ—è¡¨
  window.addEventListener('keydown', (e)=>{
    const key = e.key.toLowerCase();
    if (key>='1' && key<='7'){
      const vi = parseInt(key,10)-1;
      const btns = document.querySelectorAll('.choice');
      if (btns[vi]) btns[vi].click(); // ä¾ç•«é¢é †åº
    }else if (key==='n'){
      nextQuestion();
    }else if (key==='p'){
      if (!els.pauseBtn.disabled) togglePause();
    }else if (key==='l'){
      document.getElementById('toggleList').click();
    }
  });

  // åˆå§‹
  renderOverview(); updateScoreboard(); resetTimerUI(); els.timerBox.hidden = true; els.pauseBtn.disabled = true;
  updateShuffleLabel();
})();
</script>
</body>
</html>
